
## 简述

缓存对于web产品的意义无需多言。对于节省性能（复杂重复的计算不必重复）、节约流量都具有很大的作用。

微信小程序中开放的缓存API，主要是针对持久缓存（数据持久化）。但对于数据的实际用途，根据不同的场景却不尽相同：

- 数据变化频繁
- 数据变化较慢，但不是不变
- 数据计算完毕，基本不会发生变化
- 无论改变与否；无论频繁与否，都是重要的留存数据。

显然，针对这些类型的数据，需要分别处理。因此需要一些缓存策略。

begonia中的`/begonia/storage/StorageManager.js`提供的`StorageManager`(简称`LS`)，包含了缓存策略和存储管理功能。

## 缓存策略

`StorageManager`的缓存策略，是时间比对。通过为每条缓存加入时间戳的方式，在读取、清理等功能时通过比对过期时间，判断保留与否。

### 分级的过期时间

将过期时间段分成数个级别:

```js
const ZERO                  = 0;                            //0ms
const SHORTEST_INVALIDATE   = 900000;                       //15 minutes
const SHORTER_INVALIDATE    = 2*SHORTEST_INVALIDATE;        //half an hour
const SHORT_INVALIDATE      = 2*SHORTER_INVALIDATE;         //one hour
const LONG_INVALIDATE       = 3*SHORT_INVALIDATE;           //three hours
const LONGER_INVALIDATE     = 2*LONG_INVALIDATE;            //six hours
const LONGEST_INVALIDATE    = 4*LONGER_INVALIDATE;          //one day
const TOO_LONG_INVALIDATE   = 2*LONGEST_INVALIDATE;         //two days
const FOREVER               = 'forever';                    //forever
const TEST_INVALIDATE       = 10000;                        //ten seconds,only for debug and test
```

像这样将不同时间段保存成常量，在比对时间时，就可以进行过期判断了。

>`StorageManager`没有限制必须使用内置的这些时间常量，因此开发者可以根据项目的需要自己定义需要的过期时间段。

### 缓存格式

每条缓存，遵循了一定的格式，这样处理的时候比较方便，由于缓存存储的方式是key-value形式，那么格式如下:

```
key: [param_1]:[param_2]: ... [param_n]:masterKey   //以冒号分隔
value: [saveTime] [SALT] [invalidateTime] [SALT] [data(string)]

```
#### 设置键名

键名，使用参数和`masterKey`的组合，以`:`分隔。
所谓`masterKey`是数据用途的识别主键，比如存储一条关于某个教师用户创建的所有班级信息的数据：

```js
//举例的数据
{
    userId:1,
    data:[
        {
            id:12,
            name:"高三一班",
            //...
        },
        //...
    ],
}
```
当前用户的`userId`为`1`，对应了一定数据`data`，我们设定他的`masterKey`为`groupList`(班级列表)，那么组成的可存储键名为:

```js
let masterKey = "1:groupList"

```

#### 设置value

之后，我们将`data`的数据变为`json`格式，那么存储在本地的存储对象中的键值对就是:

```js
{
    "1:groupList":"1520412909873|*&@_@&*|900000|*&@_@&*|[...]"
}
```

其中，
- `saveTime`是存储数据时的时间戳，
- `invalidateTime`是缓存的过期时间，
- `SALT`(在`StorageManager`中为`"|*&@_@&*|"`，目前暂不开放修改)是分隔时间戳和数据的标识。

### 判断是否过期

判断过期的公式是:

```
读取时间 - 存储时间 >= 设定的有效时间段
```

在每次读取数据时，会记录当前时间，通过比对缓存中的存储时间，决定是否使用数据，或者删除数据缓存。

### 过期处理

`StorageManager`在管理缓存过期时有2种方式:

1. 在读取每条数据时，判断是否过期。如果过期就立即删除数据，反之，则返回缓存数据。
2. 提供了全部数据的检查方法，可以在系统空闲时、将要关闭时和长时间处于后台时，主动调用方法，进行缓存检查和清理。




## 概述

帧循环管理主要用来处理动画和一些特定效果。

当需要按照一个固定时间间隔来处理与UI相关的需求时，可以考虑使用帧循环管理。
例如：动画和在画布上进行动态绘制等。

帧管理器是一个单例对象，也就是说，只会有一个帧对象进行持续变化。

## 快速使用

### 0. 导入文件

```js
import Frame from '../begonia/frame/FrameLite.js';
```

### 1. 注册回调函数

对于帧的监听，首先要注册一个回调函数，用来订阅帧的变化。

使用`Frame.addFrame()`即可:

```js
//...
onReady(){
    //注册一个回调，订阅变化
    Frame.addFrame(this.onFrameHandler);
},
//...
/**
 * 自定义的帧处理函数
 * */
onFrameHandler(duration){
    //do something
    //注意这里的this并不是指向页面或组件实例，下文有解决方式。
},
//...
```

#### 参数`duration`

帧管理器会为每个注册的回调函数传入一个参数`duration`，是一个`Number`类型的值。
它表示上一帧到这一帧，所经过的毫秒数。通常我们可以用它来让动画变化平滑进行。

特别，因为帧是可以停止的(`stopFrame()`)，也是可以再启动的。因此，`duration`的计时会在帧停止时进行归零。再下次帧启动时在开始。
确保每次传给回调函数的持续时间是准确时间间隔。

此外，同js的`setTimeout`类似，帧的时间间隔是平均但不固定的。默认帧的频率是`60fps`，也就是`1000/60`毫秒，但是实际运行中，并不是每次都是精确的。这受制于js运行时执行代码的情况。如果代码中有引起长时间阻塞的代码，时间间隔会被拉长。

### 2. 移除注册的回调函数

某些时刻，当我们对帧的监听和处理已经足够，不再需要继续订阅变化时。也可以取消对帧变化的订阅。

使用`Frame.removeFrame()`：

```js
//...
cancelFrameHandler(){
    Frame.removeFrame(this.onFrameHandler);
},
//...
```

至此，帧的基本使用介绍已完成。

## 帧管理器的其他功能

### 帧循环的频率是可以设置的

使用`Frame.fps`就可以设置或者读取帧频，默认设置为`60`

```js
//符合人眼感觉的基础帧率
Frame.fps = 24;
//做动画较好的帧率
Frame.fps = 36;
//游戏以及平滑动画的理想帧率
Frame.fps = 60;
```

### 中断帧循环以及再启动

中断帧循环可以使用:

```js
Frame.stopFrame();
```

此时，帧管理器会中断帧循环。但是并不会将所有注册的回调清除。

再启动帧循环可以使用:

```js
Frame.startFrame();
```

>注意，再启动帧循环会引起对回调函数注册列表的检查，如果没有回调函数订阅帧变化。帧循环仍然不会启动。

### 惰性启动

帧管理器是具有惰性的。只有当回调函数注册列表不为空，也就是有对象订阅变化时，帧循环才会启动。

而相对的，当删除一个回调函数时，帧管理器也会去检查当前是否还有别的注册回调。如果没有，帧循环将会停止。

>注意，帧循环是需要耗费系统资源的，因此如果没有逻辑需要处理，记得要及时的取消订阅的回调函数。让帧循环停下来。或者直接停止帧循环，以节省资源。

### 检查是否注册

当想要了解一个回调函数是否已经被注册，可以使用`Frame.hasFrame()`进行检查。

```js
//...
onUnload(){
    if(Frame.hasFrame(this.onFrameHandler)){
        Frame.removeFrame(this.onFrameHandler);
    }
},
//...
onFrameHandler(duration){
    //handle frame loop
},
```

### 处理回调函数中的`this`

当我们在页面实例或者组件实例中订阅帧变化时，很可能需要在回调函数中使用`this`。我们可以用下列方式处理:

#### 设置一个实例变量保存回调函数引用

```js
Page({
    frameFn:null,
    onReady(){
        this.frameFn = this.onFrameHandler.bind(this);
        Frame.addFrame(this.frameFn);
    },
    onUnload(){
        if(Frame.hasFrame(this.frameFn)){
            Frame.removeFrame(this.frameFn);
        }
    },
    onFrameHandler(duration){
        //do something
    },
});

```

#### 在函数上附加属性

```js
Page({
    onReady(){
        this.onFrameHandler.frameFn = this.onFrameHandler.bind(this);
        Frame.addFrame(this.onFrameHandler.frameFn);
    },
    onUnload(){
        let fn = this.onFrameHandler.frameFn;
        if(typeof fn === 'function' && Frame.hasFrame(fn)){
            Frame.removeFrame(fn);
            this.onFrameHandler.frameFn = null;
        }
    },
    onFrameHandler(duration){
        //do something
    },
});

```